<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFM - Rotulagem Nutricional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* Estilos Padrão Anvisa - Tipografia Fixa 8pt */
        .anvisa-table-container {
            font-family: Arial, Helvetica, sans-serif;
            color: black;
            background: white;
            font-size: 8pt; /* 10.66px */
            line-height: 1.2;
            text-align: left;
            font-weight: normal;
        }
        .anvisa-table {
            border: 1px solid black;
            width: 100%;
            box-sizing: border-box;
            border-collapse: collapse;
        }
        .anvisa-header { border-bottom: 3px solid black; padding: 2px; }
        .anvisa-header h2 { font-size: 10pt; font-weight: bold; margin: 0; }
        .anvisa-row { border-bottom: 1px solid black; display: flex; justify-content: space-between; padding: 1px 2px; }
        .anvisa-row.indent-1 { padding-left: 10px; }
        .anvisa-row.indent-2 { padding-left: 20px; }
        .anvisa-row-thick { border-bottom: 2px solid black; display: flex; justify-content: space-between; padding: 1px 2px; font-weight: bold; }
        
        /* Formato Quebrado (Split) */
        .anvisa-quebrado-container {
            display: flex;
            gap: 10px;
            border: 1px solid black;
            padding: 2px;
        }
        .anvisa-quebrado-col { flex: 1; }

        /* Formato Linear */
        .anvisa-linear {
            border: 1px solid black;
            padding: 4px;
            text-align: justify;
        }
        .anvisa-linear strong { font-size: 9pt; display: block; margin-bottom: 2px; font-weight: bold; }
        
        /* Lupa Frontal */
        .lupa-wrapper {
            display: flex;
            font-family: Arial, sans-serif;
            color: black;
            background: white;
            border: 2px solid black;
            border-radius: 6px;
            overflow: hidden;
            width: fit-content;
            margin: 0 auto;
        }
        .lupa-header-box {
            display: flex;
            align-items: center;
            padding: 4px 6px;
            font-weight: 900;
            font-size: 10pt;
            border-right: 2px solid black;
            background: white;
        }
        .lupa-header-box i { font-size: 14pt; margin-right: 4px; transform: scaleX(-1); }
        .lupa-items-container {
            display: flex;
            background: black;
            padding: 2px;
            gap: 2px;
        }
        .lupa-item {
            background-color: black;
            color: white;
            font-weight: 900;
            text-align: center;
            padding: 4px 6px;
            font-size: 8pt;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid white;
            border-radius: 3px;
        }
        
        .lupa-layout-horizontal .lupa-wrapper { flex-direction: row; }
        .lupa-layout-horizontal .lupa-items-container { flex-direction: row; }
        
        .lupa-layout-vertical .lupa-wrapper { flex-direction: column; }
        .lupa-layout-vertical .lupa-header-box { border-right: none; border-bottom: 2px solid black; justify-content: center; }
        .lupa-layout-vertical .lupa-items-container { flex-direction: column; }

        /* Edição e Utilitários */
        #exportArea { background: white; margin: 0 auto; }
        .editable-cell {
            cursor: text;
            transition: background 0.2s;
            padding: 0 1px;
            border-radius: 2px;
            display: inline-block;
            min-width: 15px;
            text-align: center;
        }
        .editable-cell:hover, .editable-cell:focus { background-color: #e2e8f0; outline: 1px dashed #06B6D4; }
        .input-mini { width: 60px; padding: 2px; text-align: center; border: 1px solid #ccc; border-radius: 4px; font-size: 11px;}
        .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        
        /* Cor Personalizada #06B6D4 */
        .bg-rfm-cyan { background-color: #06B6D4; }
        .text-rfm-cyan { color: #06B6D4; }
        .border-rfm-cyan { border-color: #06B6D4; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans text-gray-800 pb-10">

    <nav class="bg-gray-900 text-white p-4 shadow-md border-b-4 border-rfm-cyan">
        <div class="container mx-auto max-w-5xl flex flex-wrap justify-between items-center gap-3">
            <h1 class="text-lg sm:text-xl font-bold tracking-wide">RFM - Rotulagem Nutricional</h1>
            <button onclick="clearAllData()" class="text-sm bg-red-600 hover:bg-red-700 px-3 py-1.5 rounded transition font-semibold">Limpar Tudo</button>
        </div>
    </nav>

    <div class="container mx-auto max-w-5xl p-4 md:p-6 space-y-6">
        
        <!-- Alertas de Legislação -->
        <div class="bg-blue-50 border-l-4 border-blue-600 p-3 rounded shadow-sm text-xs">
            <p class="font-bold text-blue-800 mb-1">Legislação Pertinente ANVISA:</p>
            <ul class="list-disc pl-5 text-blue-700">
                <li><a href="https://www.in.gov.br/en/web/dou/-/instrucao-normativa-in-n-75-de-8-de-outubro-de-2020-282071143" target="_blank" class="underline hover:text-blue-900">IN 75/2020 (Requisitos Técnicos)</a></li>
                <li><a href="https://anvisalegis.datalegis.net/action/ActionDatalegis.php?acao=abrirTextoAto&link=S&tipo=RDC&numeroAto=00000429&seqAto=000&valorAno=2020&orgao=RDC/DC/ANVISA/MS&cod_modulo=310&cod_menu=9431" target="_blank" class="underline hover:text-blue-900">RDC nº 429/2020 (Rotulagem Nutricional)</a></li>
            </ul>
        </div>

        <!-- PASSO 1 e 2 -->
        <div class="bg-white p-4 rounded-xl shadow border border-gray-200">
            <h2 class="text-sm font-bold text-gray-700 mb-2"><span class="bg-gray-800 text-white px-2 py-1 rounded mr-2">1º PASSO</span> Consultar Tabelas Nutricionais</h2>
            <p class="text-xs text-gray-600 mb-3">Para preencher os dados, procure a informação nutricional do alimento consultando as seguintes tabelas:</p>
            <ul class="list-decimal pl-5 text-xs space-y-1 mb-4 text-blue-600 break-words">
                <li><strong>Recomendada:</strong> <a href="https://fdc.nal.usda.gov/" target="_blank" class="underline">USDA (Base de Dados dos EUA)</a></li>
                <li><a href="https://www.tbca.net.br/base-dados/composicao_alimentos.php#" target="_blank" class="underline">TBCA (Tabela Brasileira)</a></li>
                <li><a href="https://www.nepa.unicamp.br/taco/tabela.php" target="_blank" class="underline">TACO (Tabela Brasileira de Composição de Alimentos)</a></li>
            </ul>

            <h2 class="text-sm font-bold text-gray-700 mb-2 mt-4"><span class="bg-gray-800 text-white px-2 py-1 rounded mr-2">2º PASSO</span> Alternativas</h2>
            <p class="text-xs text-gray-600">Caso não queira consultar as tabelas, poderá fazer análise laboratorial da composição dos alimentos ou ler a tabela nutricional de cada alimento composto na receita.</p>
        </div>

        <!-- PASSO 3 -->
        <div class="bg-white p-4 md:p-5 rounded-xl shadow border border-rfm-cyan relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-rfm-cyan"></div>

            <h2 class="text-md font-bold text-rfm-cyan mb-2 border-b border-gray-100 pb-2"><span class="bg-rfm-cyan text-white px-2 py-1 rounded mr-2">3º PASSO</span> Ingredientes da Receita</h2>
            <p class="text-[11px] text-red-600 mb-4 italic">OBS: Esses dados da receita devem ser solicitados ao responsável pela sua elaboração.</p>
            
            <div class="mb-4">
                <label class="block text-xs font-semibold text-gray-700">Nome da Receita</label>
                <input type="text" id="recipeName" placeholder="Ex: Bolo de Cenoura" class="w-full border border-gray-300 rounded p-2 text-sm" onchange="updateCalculations()">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 bg-gray-50 p-3 rounded border border-gray-200">
                <div>
                    <label class="block text-xs font-semibold text-gray-700">Rendimento Total da Receita</label>
                    <div class="flex items-center gap-2 mt-1">
                        <input type="number" id="recipeYield" placeholder="Ex: 1000" class="w-full border border-gray-300 rounded p-2 text-sm" oninput="updateCalculations()">
                        <select id="yieldUnit" class="border border-gray-300 rounded p-2 text-sm bg-white" onchange="updateCalculations()">
                            <option value="g">g</option>
                            <option value="ml">ml</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-700">Fatias/Unidades rendidas</label>
                    <input type="text" id="recipeSlices" placeholder="Ex: 6 potes, 2 fatias..." class="w-full border border-gray-300 rounded p-2 text-sm mt-1">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-700 text-blue-800">Peso/Volume por Unid. ou Pote (g/ml)</label>
                    <input type="number" id="unitWeight" placeholder="Ex: 200" class="w-full border border-blue-400 bg-blue-50 rounded p-2 text-sm mt-1" oninput="updateCalculations()">
                </div>
            </div>

            <!-- Adicionar Ingrediente movido para baixo das configurações de rendimento -->
            <div class="mb-4 bg-white p-3 rounded border border-gray-200">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Adicionar Ingrediente utilizado na receita</label>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="newIngName" placeholder="Ex: Farinha de Trigo" class="flex-grow border border-gray-300 rounded p-2 text-sm">
                    <input type="number" id="newIngWeight" placeholder="Qtd (g/ml)" class="w-full sm:w-28 border border-gray-300 rounded p-2 text-sm">
                    <button onclick="addBaseIngredient()" class="w-full sm:w-auto bg-rfm-cyan text-white px-5 py-2 rounded hover:bg-cyan-600 transition font-bold"><i class="fas fa-plus"></i> Add</button>
                </div>
                
                <ul id="baseIngredientsList" class="space-y-2 mt-4 max-h-40 overflow-y-auto">
                    <!-- Itens adicionados -->
                </ul>
            </div>
        </div>

        <!-- PASSO 4 -->
        <div class="bg-white p-4 md:p-5 rounded-xl shadow border border-gray-200">
            <h2 class="text-sm font-bold text-gray-700 mb-2 border-b pb-2"><span class="bg-gray-800 text-white px-2 py-1 rounded mr-2">4º PASSO</span> Alimentos da Receita (por 100g)</h2>
            <p class="text-xs text-gray-600 mb-3">Preencha os nutrientes baseando-se em <strong>100g</strong> de cada ingrediente. <span class="text-blue-600">(As calorias são calculadas automaticamente.).</span></p>
            
            <div class="flex justify-end mb-2">
                <button onclick="addCustomNutrient()" class="text-[10px] bg-purple-600 text-white px-3 py-1.5 rounded hover:bg-purple-700 font-bold">+ Add Nutriente Extra</button>
            </div>

            <div class="table-wrap border border-gray-200 rounded">
                <table class="w-full text-left text-xs whitespace-nowrap" id="nutrientsTable">
                    <thead class="bg-gray-800 text-white">
                        <tr id="nutrientsHeader">
                            <!-- Dinamico -->
                        </tr>
                    </thead>
                    <tbody id="nutrientsBody" class="bg-white">
                        <tr><td colspan="12" class="p-4 text-center text-gray-400">Adicione ingredientes no 3º passo.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- PASSO 5 (Renomeado e com obs) -->
        <div class="bg-white p-4 md:p-5 rounded-xl shadow border border-gray-200">
            <h2 class="text-sm font-bold text-gray-700 mb-2"><span class="bg-gray-800 text-white px-2 py-1 rounded mr-2">5º PASSO</span> Cálculo de Proporção</h2>
            <p class="text-[11px] text-gray-600 mb-1">Soma dos nutrientes com base na quantidade e reajuste para 100g.</p>
            <p class="text-[11px] text-blue-600 font-bold mb-3">Obs: isso aqui é só para fins informativos, pois já foram adicionados automaticamente na tabela nutricional.</p>
            <div class="bg-gray-100 p-3 rounded font-mono text-[11px] overflow-x-auto" id="calculationLog">
                Aguardando dados...
            </div>
        </div>

        <!-- RESULTADO FINAL -->
        <div class="space-y-6 mt-8">
            
            <!-- Configurações do Produto Final Movidas para cá -->
            <div class="p-4 md:p-5 rounded-xl border border-rfm-cyan shadow-md" style="background-color: #f0fdff;">
                <h3 class="font-bold text-md text-rfm-cyan mb-4"><i class="fas fa-cogs mr-1"></i> Configurações do Produto Final</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-xs font-semibold text-gray-700">Tipo de Alimento (Para Lupa)</label>
                        <select id="foodType" class="w-full border border-gray-300 rounded p-2 text-sm mt-1" onchange="updateCalculations()">
                            <option value="solid">Sólido ou Semissólido</option>
                            <option value="liquid">Líquido</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-700">Formato da Tabela Nutricional</label>
                        <select id="tableFormat" class="w-full border border-gray-300 rounded p-2 text-sm mt-1" onchange="updateCalculations()">
                            <option value="vertical">Vertical (Padrão)</option>
                            <option value="quebrado">Vertical Quebrado</option>
                            <option value="linear">Linear</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-[11px] font-semibold text-gray-700">Tamanho da Porção (g/ml) <span class="font-normal text-rfm-cyan">(consulte IN 75/2020 Anexo V)</span></label>
                        <input type="number" id="portionSize" placeholder="Ex: 50" class="w-full border border-gray-300 rounded p-2 mt-1 text-sm" oninput="updateCalculations()">
                    </div>
                    <div>
                        <label class="block text-[11px] font-semibold text-gray-700">Medida Caseira <span class="font-normal">(ex: 1 fatia)</span></label>
                        <input type="text" id="householdMeasure" placeholder="Ex: 1 fatia" class="w-full border border-gray-300 rounded p-2 mt-1 text-sm" oninput="updateCalculations()">
                        <p class="text-[9px] text-gray-500 mt-1 leading-tight">Obs: a medida caseira precisa ser pesada de acordo com a porção estabelecida acima.</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-semibold text-gray-700">Layout da Lupa Frontal</label>
                        <select id="lupaFormat" class="w-full border border-gray-300 rounded p-2 text-sm mt-1" onchange="updateCalculations()">
                            <option value="horizontal">Alinhamento Horizontal</option>
                            <option value="vertical">Alinhamento Vertical</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Cabeçalho Tabela e Botão PDF -->
            <div class="flex flex-col sm:flex-row justify-between items-center bg-white p-4 rounded-xl shadow border border-gray-200 gap-4">
                <h2 class="text-md font-bold text-gray-800">Tabela Final e Exportação</h2>
                <button onclick="downloadPDF()" class="w-full sm:w-auto bg-gray-900 hover:bg-black text-white px-6 py-2.5 rounded font-bold flex justify-center items-center gap-2 shadow transition text-sm">
                    <i class="fas fa-file-pdf"></i> Salvar PDF
                </button>
            </div>

            <div class="bg-white p-3 rounded shadow mb-4 text-[11px] border-l-4 border-yellow-500 w-full mx-auto">
                <i class="fas fa-info-circle text-yellow-600 mr-1"></i> 
                <strong>Interativo:</strong> Clique nos números da tabela para alterá-los manualmente se necessário.
            </div>

            <!-- ÁREA DE EXPORTAÇÃO PDF -->
            <div id="exportArea" class="rounded-xl shadow-lg border border-gray-200 relative bg-white p-4 sm:p-8">
                
                <!-- Lupa Frontal (Renderização Dinâmica) -->
                <div class="mb-6 flex justify-center items-center rounded print-no-bg" id="lupaContainerSection">
                    <div id="lupaRenderArea" class="lupa-layout-horizontal">
                        <!-- Injetado pelo JS -->
                    </div>
                </div>

                <!-- Containers para os diferentes formatos de Tabela -->
                <div class="anvisa-table-container mx-auto" style="max-width: 340px;" id="containerVertical">
                    <!-- Tabela Vertical -->
                </div>

                <div class="anvisa-table-container mx-auto" style="max-width: 500px;" id="containerQuebrado">
                    <!-- Tabela Vertical Quebrada -->
                </div>

                <div class="anvisa-table-container mx-auto" style="max-width: 420px;" id="containerLinear">
                    <!-- Tabela Linear -->
                </div>

                <!-- Créditos (Impressos no PDF) -->
                <div class="mt-8 pt-4 border-t border-gray-200 text-center text-[10px] text-gray-500 w-full" id="creditsSection">
                    <p>Criado por <a href="https://www.instagram.com/romulof.monteiro/" target="_blank" class="font-bold text-rfm-cyan hover:underline">Rômulo Ferreira Monteiro</a> (RFM)</p>
                    <p class="text-[9px]">Baseado na IN 75/2020 e RDC 429/2020 - ANVISA</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Valores de Referência VDR
        const VDR = { 
            energy: 2000, carbs: 300, addedSugars: 50, proteins: 50, totalFats: 65, 
            satFats: 20, transFats: 2, monoFats: 20, cholesterol: 300, fiber: 25, sodium: 2000
        };

        // Limites Rotulagem Frontal (Sólido vs Líquido)
        const LIMITS = { 
            solid: { addedSugars: 15, satFats: 6, sodium: 600 },
            liquid: { addedSugars: 7.5, satFats: 3, sodium: 300 }
        };

        let ingredients = [];
        let customColumns = []; 
        
        let baseNutrients = [
            { key: 'carbs', label: 'Carb', unit: 'g', print: 'Carboidratos totais' },
            { key: 'totalSugars', label: 'Açúcar Tot', unit: 'g', print: 'Açúcares totais' },
            { key: 'addedSugars', label: 'Açúcar Adic', unit: 'g', print: 'Açúcares adicionados' },
            { key: 'proteins', label: 'Prot', unit: 'g', print: 'Proteínas' },
            { key: 'totalFats', label: 'Gord Tot', unit: 'g', print: 'Gorduras totais' },
            { key: 'satFats', label: 'Gord Sat', unit: 'g', print: 'Gorduras saturadas' },
            { key: 'transFats', label: 'Gord Trans', unit: 'g', print: 'Gorduras trans' },
            { key: 'fiber', label: 'Fibras', unit: 'g', print: 'Fibra alimentar' },
            { key: 'sodium', label: 'Sódio', unit: 'mg', print: 'Sódio' }
        ];

        function addBaseIngredient() {
            const name = document.getElementById('newIngName').value;
            const weight = parseFloat(document.getElementById('newIngWeight').value);
            
            if (!name || isNaN(weight)) { alert('Preencha nome e quantidade!'); return; }

            const id = Date.now().toString();
            let ing = { id, originalName: name, displayName: name, weight, nutrients: {} };
            
            baseNutrients.forEach(n => ing.nutrients[n.key] = 0);
            customColumns.forEach(c => ing.nutrients[c.id] = 0);

            ingredients.push(ing);
            document.getElementById('newIngName').value = '';
            document.getElementById('newIngWeight').value = '';
            
            updateHeader();
            updateUI();
        }

        function removeIngredient(id) {
            ingredients = ingredients.filter(i => i.id !== id);
            updateUI();
        }

        function addCustomNutrient() {
            const name = prompt('Nome do Nutriente Extra (Ex: Cálcio):');
            if (!name) return;
            const unit = prompt('Unidade de medida (g, mg ou ug):', 'mg') || 'mg';
            
            const colId = 'cust_' + Date.now();
            customColumns.push({ id: colId, name, unit });
            
            ingredients.forEach(ing => ing.nutrients[colId] = 0);
            updateHeader();
            updateUI();
        }

        function removeCustomNutrient(id) {
            if(!confirm('Remover este nutriente?')) return;
            customColumns = customColumns.filter(c => c.id !== id);
            ingredients.forEach(ing => delete ing.nutrients[id]);
            updateHeader();
            updateUI();
        }

        function removeBaseNutrient(key) {
            if(!confirm('Remover este nutriente da tabela?')) return;
            baseNutrients = baseNutrients.filter(n => n.key !== key);
            ingredients.forEach(ing => delete ing.nutrients[key]);
            updateHeader();
            updateUI();
        }

        function updateHeader() {
            let tr = document.getElementById('nutrientsHeader');
            let html = `<th class="p-2 border-r border-gray-600 bg-gray-900 sticky left-0 z-10">Alimento</th>`;
            
            baseNutrients.forEach(n => {
                let colorClass = ['addedSugars', 'satFats', 'sodium'].includes(n.key) ? 'text-red-300' : '';
                html += `<th class="p-2 text-center border-r border-gray-600 ${colorClass}">
                    ${n.label} (${n.unit})
                    <button onclick="removeBaseNutrient('${n.key}')" class="text-red-400 ml-1 hover:text-red-300"><i class="fas fa-times"></i></button>
                </th>`;
            });

            customColumns.forEach(c => {
                html += `<th class="p-2 text-center border-r border-gray-600 text-purple-300">
                    ${c.name} (${c.unit}) 
                    <button onclick="removeCustomNutrient('${c.id}')" class="text-red-400 ml-1"><i class="fas fa-times"></i></button>
                </th>`;
            });
            tr.innerHTML = html;
        }

        function updateUI() {
            const list = document.getElementById('baseIngredientsList');
            list.innerHTML = '';
            ingredients.forEach(ing => {
                list.innerHTML += `
                    <li class="flex justify-between items-center bg-gray-50 p-2 rounded border border-gray-200 text-sm">
                        <span class="font-bold">${ing.originalName} <span class="font-normal text-gray-500">(${ing.weight}g/ml)</span></span>
                        <button onclick="removeIngredient('${ing.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                    </li>`;
            });

            const tbody = document.getElementById('nutrientsBody');
            if (ingredients.length === 0) {
                tbody.innerHTML = `<tr><td colspan="15" class="p-4 text-center text-gray-400">Adicione ingredientes no 3º passo.</td></tr>`;
            } else {
                let html = '';
                ingredients.forEach((ing) => {
                    html += `<tr class="border-b hover:bg-gray-50">
                        <td class="p-1 border-r sticky left-0 bg-white z-10">
                            <input type="text" value="${ing.displayName}" onchange="updateIngName('${ing.id}', this.value)" class="w-full p-1 border rounded text-[11px]">
                        </td>`;
                    
                    baseNutrients.forEach(n => {
                        html += `<td class="p-1 border-r text-center"><input type="number" step="0.1" value="${ing.nutrients[n.key]}" onchange="updateNutrient('${ing.id}', '${n.key}', this.value)" class="input-mini"></td>`;
                    });

                    customColumns.forEach(c => {
                        html += `<td class="p-1 border-r text-center bg-purple-50"><input type="number" step="0.1" value="${ing.nutrients[c.id]}" onchange="updateNutrient('${ing.id}', '${c.id}', this.value)" class="input-mini border-purple-300"></td>`;
                    });
                    html += `</tr>`;
                });
                tbody.innerHTML = html;
            }

            updateCalculations();
        }

        function updateIngName(id, val) {
            let ing = ingredients.find(i => i.id === id);
            if(ing) ing.displayName = val;
            updateCalculations();
        }

        function updateNutrient(id, key, val) {
            let ing = ingredients.find(i => i.id === id);
            if(ing) ing.nutrients[key] = parseFloat(val) || 0;
            updateCalculations();
        }

        function clearAllData() {
            if(confirm("Deseja apagar tudo?")) {
                ingredients = [];
                customColumns = [];
                document.getElementById('recipeYield').value = '';
                document.getElementById('unitWeight').value = '';
                document.getElementById('portionSize').value = '';
                document.getElementById('householdMeasure').value = '';
                updateHeader();
                updateUI();
            }
        }

        // Regras de Arredondamento Anvisa
        function formatAnvisa(value, unit) {
            if (value === undefined || value === null || isNaN(value) || value <= 0.0001) return "0";
            if (value >= 10) return Math.round(value).toString();
            if (value >= 1 && value < 10) {
                let val = Math.round(value * 10) / 10;
                return val % 1 === 0 ? val.toString() : val.toFixed(1).replace('.', ',');
            }
            if (value < 1 && unit === 'g') {
                let val = Math.round(value * 10) / 10;
                return val.toFixed(1).replace('.', ',');
            }
            if (value < 1 && (unit === 'mg' || unit === 'ug' || unit === 'µg')) {
                let val = Math.round(value * 100) / 100;
                if ((val * 10) % 1 === 0) return val.toFixed(1).replace('.', ',');
                return val.toFixed(2).replace('.', ',');
            }
            return "0";
        }

        function calculateVD(value, paramName) {
            let vdrValue = VDR[paramName];
            if(!vdrValue) return null;
            let percent = (value / vdrValue) * 100;
            return Math.round(percent).toString();
        }

        // Cálculos e Renderização
        function updateCalculations() {
            const yieldVal = parseFloat(document.getElementById('recipeYield').value) || 0;
            const portion = parseFloat(document.getElementById('portionSize').value) || 0;
            const unitWeight = parseFloat(document.getElementById('unitWeight').value) || 0;
            const yieldUnit = document.getElementById('yieldUnit').value;
            const foodType = document.getElementById('foodType').value;
            const tableFormat = document.getElementById('tableFormat').value;

            // Nova regra de "Porções por embalagem" com o Peso da Unidade (ou pote)
            let portionsPerPack = "0";
            if(unitWeight > 0 && portion > 0) {
                let calc = unitWeight / portion;
                portionsPerPack = (calc % 1 === 0) ? calc.toString() : calc.toFixed(1).replace('.', ',');
            } else if(yieldVal > 0 && portion > 0) {
                // Fallback se a pessoa não preencheu o Peso do Pote
                let calc = yieldVal / portion;
                portionsPerPack = (calc % 1 === 0) ? calc.toString() : calc.toFixed(1).replace('.', ',');
            }

            let totals = { energy: 0 };
            baseNutrients.forEach(n => totals[n.key] = 0);
            customColumns.forEach(c => totals[c.id] = 0);

            ingredients.forEach(ing => {
                let mult = ing.weight / 100;
                baseNutrients.forEach(n => totals[n.key] += (ing.nutrients[n.key] * mult));
                customColumns.forEach(c => totals[c.id] += (ing.nutrients[c.id] * mult));
            });

            const tCarbs = totals.carbs || 0;
            const tProts = totals.proteins || 0;
            const tFats = totals.totalFats || 0;
            const tFib = totals.fiber || 0;
            totals.energy = (tCarbs * 4) + (tProts * 4) + (tFats * 9) + (tFib * 2);

            let final100 = {};
            let finalPor = {};
            let logHtml = `<strong>Resumo - Rendimento Declarado:</strong> ${yieldVal}${yieldUnit}<br><br>`;
            
            let factor100 = yieldVal > 0 ? (100 / yieldVal) : 0;
            let factorPor = yieldVal > 0 ? (portion / yieldVal) : 0;

            ['energy', ...baseNutrients.map(n=>n.key), ...customColumns.map(c=>c.id)].forEach(k => {
                final100[k] = totals[k] * factor100;
                finalPor[k] = totals[k] * factorPor;
                
                if(k !== 'energy' && totals[k] > 0) {
                    logHtml += `Soma total de <strong>${k}</strong> na receita = ${totals[k].toFixed(2)} -> reajuste p/ 100g: ${(final100[k]).toFixed(2)}<br>`;
                }
            });

            document.getElementById('calculationLog').innerHTML = yieldVal > 0 ? logHtml : 'Insira o rendimento para visualizar o cálculo de proporção.';

            renderLupa(final100, foodType);
            renderTables(final100, finalPor, tableFormat, portionsPerPack, portion, yieldUnit);
        }

        function renderLupa(final100, foodType) {
            const limits = LIMITS[foodType];
            const alerts = [];
            if (final100.addedSugars >= limits.addedSugars) alerts.push("AÇÚCAR<br>ADICIONADO");
            if (final100.satFats >= limits.satFats) alerts.push("GORDURA<br>SATURADA");
            if (final100.sodium >= limits.sodium) alerts.push("SÓDIO");

            const container = document.getElementById('lupaContainerSection');
            const renderArea = document.getElementById('lupaRenderArea');
            const layoutType = document.getElementById('lupaFormat').value; 

            if (alerts.length === 0) {
                container.classList.add('hidden');
                return;
            }
            container.classList.remove('hidden');
            
            renderArea.className = `lupa-layout-${layoutType}`;

            let html = `
                <div class="lupa-wrapper">
                    <div class="lupa-header-box"><i class="fas fa-search"></i><span>ALTO EM</span></div>
                    <div class="lupa-items-container">
            `;
            alerts.forEach(al => {
                html += `<div class="lupa-item">${al}</div>`;
            });
            html += `</div></div>`;
            renderArea.innerHTML = html;
        }

        function getRowHtml(label, indent, val100, valPor, unit, vdrKey) {
            let f100 = formatAnvisa(val100, unit);
            let fPor = formatAnvisa(valPor, unit);
            let vd = vdrKey ? calculateVD(valPor, vdrKey) : null;
            let fVd = vd !== null ? vd : '';
            return `
            <div class="anvisa-row ${indent}">
                <span>${label}</span>
                <div style="display:flex; gap:2px; width: 110px; justify-content: flex-end; text-align: right;">
                    <span style="width: 35px;" class="editable-cell" contenteditable="true">${f100}</span>
                    <span style="width: 35px;" class="editable-cell" contenteditable="true">${fPor}</span>
                    <span style="width: 25px;" class="editable-cell" contenteditable="true">${fVd}</span>
                </div>
            </div>`;
        }

        function renderTables(f100, fPor, format, portions, portionSize, unit) {
            document.getElementById('containerVertical').style.display = 'none';
            document.getElementById('containerQuebrado').style.display = 'none';
            document.getElementById('containerLinear').style.display = 'none';

            let measure = document.getElementById('householdMeasure').value || "...";
            let pSizeText = portionSize > 0 ? portionSize : "...";
            
            let headerText = `Porções por embalagem: ${portions} porções<br>Porção: ${pSizeText} ${unit} (${measure})`;
            let headerCols = `
                <span></span>
                <div style="display:flex; gap:2px; width: 110px; justify-content: flex-end; text-align: center;">
                    <span style="width: 35px;">100 ${unit}</span>
                    <span style="width: 35px;">${pSizeText} ${unit}</span>
                    <span style="width: 25px;">%VD*</span>
                </div>`;

            const hasN = (key) => baseNutrients.some(n => n.key === key);

            let leftRows = [];
            leftRows.push(getRowHtml('Valor energético (kcal)', '', f100.energy, fPor.energy, 'g', 'energy'));
            if(hasN('carbs')) leftRows.push(getRowHtml('Carboidratos totais (g)', '', f100.carbs, fPor.carbs, 'g', 'carbs'));
            if(hasN('totalSugars')) leftRows.push(getRowHtml('Açúcares totais (g)', 'indent-1', f100.totalSugars, fPor.totalSugars, 'g', null));
            if(hasN('addedSugars')) leftRows.push(getRowHtml('Açúcares adicionados (g)', 'indent-2', f100.addedSugars, fPor.addedSugars, 'g', 'addedSugars'));
            if(hasN('proteins')) leftRows.push(getRowHtml('Proteínas (g)', '', f100.proteins, fPor.proteins, 'g', 'proteins'));
            
            let rightRows = [];
            if(hasN('totalFats')) rightRows.push(getRowHtml('Gorduras totais (g)', '', f100.totalFats, fPor.totalFats, 'g', 'totalFats'));
            if(hasN('satFats')) rightRows.push(getRowHtml('Gorduras saturadas (g)', 'indent-1', f100.satFats, fPor.satFats, 'g', 'satFats'));
            if(hasN('transFats')) rightRows.push(getRowHtml('Gorduras trans (g)', 'indent-1', f100.transFats, fPor.transFats, 'g', 'transFats'));
            if(hasN('fiber')) rightRows.push(getRowHtml('Fibra alimentar (g)', '', f100.fiber, fPor.fiber, 'g', 'fiber'));
            if(hasN('sodium')) rightRows.push(getRowHtml('Sódio (mg)', '', f100.sodium, fPor.sodium, 'mg', 'sodium'));

            customColumns.forEach(c => {
                let pk = c.name.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); 
                rightRows.push(getRowHtml(`${c.name} (${c.unit})`, '', f100[c.id], fPor[c.id], c.unit, pk));
            });

            const footerHtml = `<div style="padding: 2px; border-top: 1px solid black;"><p style="margin:0; font-size: 8pt; text-align: justify;" contenteditable="true" id="footerNote">*Percentual de valores diários fornecidos pela porção.</p></div>`;

            if (format === 'vertical') {
                let html = `
                <div class="anvisa-table">
                    <div class="anvisa-header"><h2>INFORMAÇÃO NUTRICIONAL</h2><p style="margin: 2px 0 0 0;">${headerText}</p></div>
                    <div class="anvisa-row-thick">${headerCols}</div>
                    ${leftRows.join('')}${rightRows.join('')}
                    ${footerHtml}
                </div>`;
                document.getElementById('containerVertical').innerHTML = html;
                document.getElementById('containerVertical').style.display = 'block';
            } 
            else if (format === 'quebrado') {
                let html = `
                <div class="anvisa-table">
                    <div class="anvisa-header"><h2>INFORMAÇÃO NUTRICIONAL</h2><p style="margin: 2px 0 0 0;">${headerText}</p></div>
                    <div class="anvisa-quebrado-container" style="border:none;">
                        <div class="anvisa-quebrado-col">
                            <div class="anvisa-row-thick">${headerCols}</div>
                            ${leftRows.join('')}
                        </div>
                        <div class="anvisa-quebrado-col" style="border-left: 2px solid black;">
                            <div class="anvisa-row-thick">${headerCols}</div>
                            ${rightRows.join('')}
                        </div>
                    </div>
                    ${footerHtml}
                </div>`;
                document.getElementById('containerQuebrado').innerHTML = html;
                document.getElementById('containerQuebrado').style.display = 'block';
            }
            else if (format === 'linear') {
                let parts = [];
                let addPart = (lbl, v1, vP, un, vd) => {
                    let sv1 = formatAnvisa(v1, un); let svP = formatAnvisa(vP, un);
                    let str = `${lbl} ${sv1} ${un} (${svP} ${un}`;
                    if(vd !== null) str += `, ${calculateVD(vP, vd) || '0'}%`;
                    str += `)`;
                    parts.push(str);
                };
                
                addPart('Valor energético', f100.energy, fPor.energy, 'kcal', 'energy');
                if(hasN('carbs')) addPart('Carboidratos', f100.carbs, fPor.carbs, 'g', 'carbs');
                if(hasN('totalSugars')) addPart('dos quais: Açúcares totais', f100.totalSugars, fPor.totalSugars, 'g', null);
                if(hasN('addedSugars')) addPart('Açúcares adicionados', f100.addedSugars, fPor.addedSugars, 'g', 'addedSugars');
                if(hasN('proteins')) addPart('Proteínas', f100.proteins, fPor.proteins, 'g', 'proteins');
                if(hasN('totalFats')) addPart('Gorduras totais', f100.totalFats, fPor.totalFats, 'g', 'totalFats');
                if(hasN('satFats')) addPart('das quais: Gorduras saturadas', f100.satFats, fPor.satFats, 'g', 'satFats');
                if(hasN('transFats')) addPart('Gorduras trans', f100.transFats, fPor.transFats, 'g', 'transFats');
                if(hasN('fiber')) addPart('Fibra alimentar', f100.fiber, fPor.fiber, 'g', 'fiber');
                if(hasN('sodium')) addPart('Sódio', f100.sodium, fPor.sodium, 'mg', 'sodium');
                customColumns.forEach(c => { addPart(c.name, f100[c.id], fPor[c.id], c.unit, null); });

                let html = `
                <div class="anvisa-linear">
                    <strong>INFORMAÇÃO NUTRICIONAL</strong>
                    <div style="border-bottom: 2px solid black; padding-bottom: 2px; margin-bottom: 2px;">
                        Porções por embalagem: ${portions} porções • Porção: ${pSizeText} ${unit} (${measure})
                    </div>
                    Por 100 ${unit} (${pSizeText} ${unit}, %VD*): ${parts.join(' • ')}.
                    <br><span style="font-size: 7pt;">*Percentual de valores diários fornecidos pela porção.</span>
                </div>`;
                document.getElementById('containerLinear').innerHTML = html;
                document.getElementById('containerLinear').style.display = 'block';
            }
        }

        function downloadPDF() {
            const element = document.getElementById('exportArea');
            
            // Remove momentaneamente as classes editáveis
            document.querySelectorAll('.editable-cell').forEach(el => el.classList.remove('editable-cell'));
            
            // Reseta temporariamente estilos que bugam no HTML2PDF (Shadows e bordas arredondadas grossas)
            element.style.boxShadow = 'none';
            element.style.borderRadius = '0';
            element.style.border = 'none';

            // scrollY: 0 resolve o bug de salvar PDF em branco quando a pessoa desceu a tela!
            const opt = {
                margin:       10, 
                filename:     'Rotulagem_Nutricional_RFM.pdf',
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true, scrollY: 0 }, 
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save().then(() => {
                // Restaura visuais da tela pós-exportação
                element.style.boxShadow = '';
                element.style.borderRadius = '';
                element.style.border = '';
                document.querySelectorAll('.anvisa-row span, #footerNote').forEach(el => {
                    if(el.hasAttribute('contenteditable')) el.classList.add('editable-cell');
                });
            });
        }

        updateHeader();
        updateUI();

    </script>
</body>
</html>